<?xml version="1.0" encoding="UTF-8"?>
<odoo>
  <data>
    <!-- Main template -->
    <template id="report_serviceorder">
      <t t-call="web.html_container">
        <t t-foreach="docs" t-as="doc">
          <t t-call="service.report_serviceorder_document" t-lang="doc.partner_id.lang"/>
        </t>
      </t>
    </template>

    <!-- Translatable template -->
    <template id="report_serviceorder_document">
      <t t-set="o" t-value="doc"/>
      <t t-call="web.external_layout">
        <t t-set="o" t-value="o.with_context(lang=o.partner_id.lang)"/>
        <t t-set="information_block">
          <strong t-if="o.address_id == o.partner_invoice_id">Invoice and Shipping address:</strong>
          <div t-if="o.partner_invoice_id">
            <strong t-if="o.address_id != o.partner_invoice_id">Invoice address: </strong>
            <div t-if="o.partner_invoice_id" t-options='{"widget": "contact", "fields": ["address", "name", "phone"], "no_marker": True, "phone_icons": True}'/>
              <p t-if="o.partner_invoice_id.vat"><t t-esc="o.company_id.country_id.vat_label or 'Tax ID'"/>: <span t-field="o.partner_invoice_id.vat"/></p>
          </div>
          <t t-if="o.address_id != o.partner_invoice_id">
            <strong>Shipping Address</strong>
            <div t-field="o.address_id" t-options='{"widget": "contact", "fields": ["address", "name", "phone"], "no_marker": True, "phone_icons": True}'/>
            <p t-if="o.address_id.vat"><t t-esc="o.company_id.country_id.vat_label or 'Tax ID'"/>: <span t-field="o.address_id.vat"/></p>
          </t>
        </t>
        <t t-set="address">
          <div t-field="o.partner_id" t-option='{"widget": "contact", "fields": ["address", "name"], "no_marker": True}'/>
        </t>
        <div class="page">
          <div class="oe_structure"/>
          <h4>
            <span t-if="o.state != 'draft'">Service Order : </span>
            <span t-if="o.state == 'draft'">Service Quotation : </span>
          </h4>

          <div id="informations" class="row mt32 mb32">
            <div class="col-3 bm-2">
              <strong>Equipment:</strong>
              <p t-field="o.equipment_id.name" class="m.o"/>
            </div>
            <div class="col-3 bm-2">
              <strong>Model:</strong>
              <p t-field="o.equipment_id.model"/>
            </div>
            <div class="col-3 bm-2">
              <strong>Customer:</strong>
              <p t-field="o.partner_id.name"/>
            </div>
          </div>

          <table class="table table-sm o_main_table">
            <thead>
              <tr>
                <th>Description</th>
                <th class="text-right">Quantity</th>
                <t t-if="o.invoice_method != 'none'">
                  <th class="text-right">Unit Price</th>
                  <th class="text-center">Tax</th>
                  <th class="text-right">Price</th>
                </t>
              </tr>
            </thead>
            <tbody>
              <t t-if="o.operations">
                <tr class="bg-200 o_line_section"><td colspan="5"><strong>Spareparts</strong></td></tr>
                <tr t-foreach="o.operations" t-as="line">
                  <td><p><span t-field="line.name"/></p></td>
                  <td class="text-right">
                    <span t-field="line.product_uom_qty"/>
                    <span t-field="line.product_uom.name" groups="uom.group_uom"/>
                  </td>
                  <t t-if="(line.service_id.invoice_method != 'none')">
                    <td class="text-right"><span t-field="line.price_unit"/></td>
                    <td class="text-center"><span t-esc="','.join(map( lambda x: x.name, line.tax_id))"/></td>
                    <td class="text-right o_price_total">
                      <span t-field="line.price_subtotal" t-options='{"widget": "monetary", "display_currency": o.currency_id}'/>
                    </td>
                  </t>
                </tr>
              </t>
              <t t-if="o.fees_lines">
                <tr class="bg-200 o_line_section"><td colspan="5"><strong>Repairs</strong></td></tr>
                <tr t-foreach="o.fees_lines" t-as="fees">
                  <td><p><span t-field="fees.name"/></p></td>
                  <td class="text-right">
                    <span t-field="fees.product_uom_qty"/>
                    <span t-field="fees.product_uom.name" groups="uom.group_uom"/>
                  </td>
                  <t t-if="(fees.service_id.invoice_method != 'none')">
                    <td class="text-right"><span t-field="fees.price_unit"/></td>
                    <td class="text-center"><span t-esc="','.join(map( lambda x: x.name, fees.tax_id))"/></td>
                    <td class="text-right o_price_total">
                      <span t-field="fees.price_subtotal" t-options='{"widget": "monetary", "display_currency": o.currency_id}'/>
                    </td>
                  </t>
                </tr>
              </t>
            </tbody>
          </table>

          <div id="total" class="row justify-content-end">
            <div class="col-4">
              <table class="table table-sm">
                <t t-if="o.invoice_method != 'none'">
                  <tr class="border-black o_subtotal">
                    <td><strong>Total W/o Taxes</strong></td>
                    <td class="text-right">
                      <span t-field="o.amount_untaxed" t-options='{"widget": "monetary", "display_currency": o.currency_id}'/>
                    </td>
                  </tr>
                  <tr>
                    <td>Taxes</td>
                    <td class="text-right o_price_total">
                      <span t-field="o.amount_tax" t-options='{"widget": "monetary", "display_currency": o.currency_id}'/>
                    </td>
                  </tr>
                  <tr class="borderblack o_total">
                    <td><strong>Total</strong></td>
                    <td class="text-right o_price_total">
                      <span t-field="o.amount_total" t-options='{"widget": "monetary", "display_currency": o.currency_id}'/>
                    </td>
                  </tr>
                </t>
              </table>
            </div>
          </div>

          <p t-field="o.quotation_notes"/>
          <div class="oe_structure"/>
        </div>
      </t>
    </template>

  </data>
</odoo>
